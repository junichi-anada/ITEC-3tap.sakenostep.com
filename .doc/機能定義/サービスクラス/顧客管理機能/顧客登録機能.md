# 顧客登録機能仕様

## 概要
顧客（Customer）の新規登録を行う機能です。この機能により、管理者やオペレーターは新しい顧客情報をシステムに登録することができます。

## 機能の対象
- オペレーター
- 管理者

## 使用テーブル構成
1. **ユーザー情報**
   - **Userモデル**（Usersテーブル）
     - フィールド:
       - `user_code`
       - `site_id`
       - `name`
       - `postal_code`
       - `address`
       - `phone`
       - `phone2`
       - `fax`
       - `created_at`
       - `updated_at`
       - `deleted_at`

     - モデルファイル: `User.php`
     - マイグレーションファイル: `03_modify_users_table.php`
     - ユニークキー: `user_code`
     - インデックス: `name`
     - 外部キー: `site_id`

2. **認証情報**
   - **Authenticateモデル**（Authenticatesテーブル）
     - フィールド:
       - `auth_code`
       - `site_id`
       - `entity_type`
       - `entity_id`
       - `login_code`
       - `password`
       - `expires_at`
       - `created_at`
       - `updated_at`
       - `deleted_at`

     - モデルファイル: `Authenticate.php`
     - マイグレーションファイル: `12_create_authenticates_table.php`
     - ユニークキー: `auth_code`
     - インデックス: `entity_type`, `entity_id`
     - 外部キー: `site_id`

## 依存関係
- Laravelフレームワーク v11.0以上
- PHP 8.3以上
- データベース（MySQL 8.0以上）
- バリデーションシステム（Laravel Validator）

## バリデーションルール
- **Userテーブル**
  1. `user_code`: 必須, ユニーク, ULIDを使用
  2. `site_id`: 必須, 存在するサイトのID
  3. `name`: 必須, 64文字以内, 日本語も許可
  4. `postal_code`: 必須, `3桁-4桁` の形式
  5. `address`: 必須, 128文字以内
  6. `phone`: 必須, ハイフン付きの日本式の電話番号（10桁または11桁）, 市外局番ありなしどちらも許容する。
  7. `phone2`: 任意, ハイフン付きの日本式の電話番号（10桁または11桁）, 市外局番ありなしどちらも許容する。
  8. `fax`: 任意, ハイフン付きの日本式の電話番号（10桁または11桁）, 市外局番ありなしどちらも許容する。

- **Authenticateテーブル**
  1. `auth_code`: 必須, ユニーク, UUIDを使用
  2. `site_id`: 必須, 存在するサイトのID
  3. `entity_type`: 必須, 文字列（'user', 'operator', 'admin'のいずれか）
  4. `entity_id`: 必須, 対応するエンティティの存在するID
  5. `login_code`: 必須, ユニーク, 英数字のみ, 4文字以上32文字以内
  6. `password`: 必須, 8文字以上32文字以内, 英大文字・小文字・数字を含む

## 機能を実行するサービスクラス
- クラス名: `App\Services\Customer\CustomerCreateService`
- 名前空間: `App\Services\Customer`
- 主要メソッド: 
  - `execute(array $data): Customer`

## 機能のビジネスロジック
1. 登録前チェック
   - サイトの存在確認: `site_id`がSitesテーブルに存在することを確認
   - 登録権限の確認: 操作を行うユーザーが登録権限を持っていることを確認
   - CSRFトークンの検証

2. リクエストデータのバリデーション
   - 必須項目の確認: `user_code`, `site_id`, `name`, `postal_code`, `address`, `phone`, `login_code`, `password`が含まれていることを確認
   - 文字数制限の確認: 
     - `name`は64文字以内
     - `postal_code`は8文字（`3桁-4桁`形式）
     - `address`は128文字以内
     - `phone`は10桁または11桁
     - `login_code`は4文字以上32文字以内
     - `password`は8文字以上32文字以内
   - 形式チェック:
     - `postal_code`は`3桁-4桁`の形式
     - `phone`はハイフン付きの日本式電話番号
     - `login_code`は英数字のみ
     - `password`は英大文字・小文字・数字を含む
   - サイトの存在確認: `site_id`がSitesテーブルに存在することを確認
   - login_codeの重複チェック: `login_code`が既に使用されていないことを確認

3. 顧客情報の生成
   - トランザクション開始
   - user_codeの生成: ULID形式で一意の`user_code`を生成
   - パスワードのハッシュ化: セキュリティのために`password`をハッシュ化
   - Usersテーブルへの登録
   - Authenticatesテーブルへの認証情報登録
   - トランザクション終了

4. レスポンス生成
   - 登録成功時: リダイレクトレスポンス（フラッシュメッセージ付き）
   - エラー時: バリデーションエラーメッセージと共に元のページにリダイレクト

## エラーハンドリング
- バリデーションエラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: 各項目のバリデーションエラー内容を返却
- サイト不在エラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "指定されたサイトが見つかりません"
- 重複エラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: 
    - user_code重複: "指定されたuser_codeは既に使用されています"
    - login_code重複: "指定されたlogin_codeは既に使用されています"
- データベースエラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "顧客情報の登録に失敗しました。システム管理者に連絡してください"
  - ログ出力: エラー詳細（SQL, パラメータ, エラーメッセージ）

## テストケース
1. 正常系
   - 必須項目のみで登録
     - 期待結果: リダイレクト（302）、フラッシュメッセージ "顧客情報を登録しました"
   - 全項目を指定して登録
     - 期待結果: リダイレクト（302）、フラッシュメッセージ "顧客情報を登録しました"

2. 異常系
   - バリデーションエラー
     - nameが64文字を超える
       - 期待結果: リダイレクト（302）、エラーメッセージ: "nameは64文字以内で入力してください"
     - login_codeが50文字を超える
       - 期待結果: リダイレクト（302）、エラーメッセージ: "login_codeは50文字以内で入力してください"
   - サイト不在エラー
     - 存在しないsite_idを指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "指定されたサイトが見つかりません"
   - 重複エラー
     - 既存のlogin_codeを指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "指定されたlogin_codeは既に使用されています"
   - CSRFトークンエラー
     - 無効なCSRFトークンでリクエスト
       - 期待結果: 419エラー

## その他
- 顧客の登録はWebUIからフォーム送信で実行されます。
- CSRFトークンによる保護が必要です。
- セッションフラッシュメッセージを使用して、処理結果をユーザーに通知します。
- トランザクション制御により、データの整合性を保証します。
