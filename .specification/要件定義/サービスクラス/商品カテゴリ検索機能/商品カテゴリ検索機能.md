# 商品カテゴリ検索機能仕様

## 概要
商品カテゴリ（ItemCategory）の検索を行う機能です。この機能により、管理者や一般ユーザーは商品カテゴリを検索・閲覧することができます。

## 機能の対象
- 管理者
- 一般ユーザー

## 使用テーブル構成
1. **商品カテゴリ情報**
    - **ItemCategoryモデル**（ItemCategoriesテーブル）
        - フィールド:
            - `category_code`: カテゴリコード
            - `site_id`: サイトID
            - `name`: カテゴリ名
            - `priority`: 優先度
            - `is_published`: 公開状態
            - `created_at`: 作成日時
            - `updated_at`: 更新日時
            - `deleted_at`: 削除日時

        - モデルファイル: `ItemCategory.php`
        - マイグレーションファイル: `07_create_item_categories_table.php`
        - ユニークキー: `category_code`
        - インデックス: `name`
        - 外部キー: `site_id`

## 参照テーブル
1. **サイト情報**
   - **Siteモデル**（Sitesテーブル）
     - フィールド:
        - `site_code`: サイトコード
        - `company_id`: 会社ID
        - `url`: サイトURL
        - `name`: サイト名
        - `description`: 説明
        - `is_btob`: BtoBフラグ
        - `created_at`: 作成日時
        - `updated_at`: 更新日時
        - `deleted_at`: 削除日時

    - モデルファイル: `Site.php`
    - マイグレーションファイル: `02_create_sites_table.php`
    - ユニークキー: `site_code`, `url`
    - インデックス: `name`, `description`
    - 外部キー: `company_id`

## 依存関係
- Laravelフレームワーク v11.0以上
- PHP 8.3以上
- データベース（MySQL 8.0以上）
- バリデーションシステム（Laravel Validator）

## 機能を実行するサービスクラス
- クラス名: `App\Services\ItemCategory\ItemCategorySearchService`
- 名前空間: `App\Services\ItemCategory`
- 主要メソッド: 
  - `execute(array $searchParams): Collection`

## バリデーションルール
- **検索条件**
  1. `category_code`: 任意, 英数字, 最大32文字
  2. `site_id`: 任意, 整数値, 存在するサイトのID
  3. `name`: 任意, 文字列, 最大64文字
  4. `is_published`: 任意, 真偽値
  5. `page`: 任意, 整数値, 1以上
  6. `per_page`: 任意, 整数値, 10, 20, 50のいずれか

## 機能のビジネスロジック
1. 検索条件のバリデーション
   - 検索条件の確認: `category_code`, `site_id`, `name`などのフィルタ条件が正しい形式であることを確認
   - CSRFトークンの検証

2. 商品カテゴリ情報の検索
   - ItemCategoriesテーブルから条件に合致する商品カテゴリを検索
   - `is_published`がtrueのカテゴリのみを対象とする（管理者は全てのカテゴリを検索可能）
   - ページネーション処理の実装

3. レスポンス生成
   - 検索成功時: 検索結果一覧ページを表示（ページネーション情報付き）
   - エラー時: エラーメッセージと共に検索フォームページにリダイレクト

## エラーハンドリング
- バリデーションエラー
  - 処理: セッションにエラーメッセージを格納し、検索フォームページにリダイレクト
  - エラーメッセージ: 各項目のバリデーションエラー内容を返却
- データベースエラー
  - 処理: セッションにエラーメッセージを格納し、検索フォームページにリダイレクト
  - エラーメッセージ: "商品カテゴリ情報の検索に失敗しました。システム管理者に連絡してください"
  - ログ出力: エラー詳細（SQL, パラメータ, エラーメッセージ）

## テストケース
1. 正常系
   - 全てのカテゴリを検索
     - 期待結果: 検索結果一覧ページが表示される
   - 特定のカテゴリコードで検索
     - 期待結果: 該当する商品カテゴリ情報が表示される
   - ページネーション
     - 期待結果: 指定したページの結果が表示される

2. 異常系
   - バリデーションエラー
     - 無効な形式のcategory_codeを指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "category_codeの形式が不正です"
   - 不正なページ番号
     - 期待結果: リダイレクト（302）、エラーメッセージ: "不正なページ番号が指定されました"
   - CSRFトークンエラー
     - 期待結果: 419エラー

## その他
- 商品カテゴリの検索はWebUIから実行されます。
- CSRFトークンによる保護が必要です。
- セッションフラッシュメッセージを使用して、処理結果をユーザーに通知します。
- ページネーション機能により、大量の検索結果を適切に表示します。
- 検索条件は検索フォームのGETパラメータとして送信されます。
