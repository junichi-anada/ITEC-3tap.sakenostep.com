# お気に入り商品更新機能仕様

## 概要
顧客が既に登録済みのお気に入り商品情報を更新する機能です。この機能により、顧客は自身のお気に入り商品リストを最新の状態に保つことができます。

## 機能の対象
- 顧客（Webサイトにログインしているユーザー）

## 属性（プロパティ）
- **userId** (int): ユーザーID
- **itemId** (int): 商品ID
- **siteId** (int): サイトID
- **companyId** (int): 会社ID
- **createdAt** (datetime): 作成日時
- **updatedAt** (datetime): 更新日時
- **deletedAt** (datetime|null): 削除日時

## 操作対象テーブル構成
1. **お気に入り商品情報**
    - **FavoriteItemモデル**（FavoriteItemsテーブル）
        - フィールド:
            'user_id',  
            'company_id',  
            'item_id',  
            'site_id',  
            'created_at',  
            'updated_at',  
            'deleted_at'

        - モデルファイル: `FavoriteItem.php`
        - マイグレーションファイル: `23_create_favorite_items_table.php`
        - ユニークキー: `user_id`, `item_id`, `site_id`
        - 外部キー: `user_id`, `item_id`, `site_id`

## 参照テーブル
1. **商品情報**
    - **Itemモデル**（Itemsテーブル）
        - フィールド:
            'item_code',  
            'site_id',  
            'category_id',  
            'maker_name',  
            'name',  
            'description',  
            'unit_price',  
            'unit_id',  
            'from_source',  
            'is_recommended',  
            'published_at',  
            'created_at',  
            'updated_at',  
            'deleted_at'

        - モデルファイル: `Item.php`
        - マイグレーションファイル: `09_create_items_table.php`
        - ユニークキー: `item_code`
        - インデックス: `name`, `description`
        - 外部キー: `site_id`, `category_id`, `unit_id`

2. **ユーザー情報**
    - **Userモデル**（Usersテーブル）
        - フィールド:
            'user_code',  
            'site_id',  
            'name',  
            'postal_code',  
            'address',  
            'phone',  
            'phone2',  
            'fax',  
            'created_at',  
            'updated_at',  
            'deleted_at'

        - モデルファイル: `User.php`
        - マイグレーションファイル: `03_modify_users_table.php`
        - ユニークキー: `user_code`
        - インデックス: `name`
        - 外部キー: `site_id`

3. **サイト情報**
   - **Siteモデル**（Sitesテーブル）
     - フィールド:
       - `site_code`: ULID形式で一意
       - `company_id`: 会社のID
       - `url`: 有効なURL形式
       - `name`: サイト名
       - `description`: サイトの説明
       - `is_btob`: BtoBフラグ
       - `created_at`: 作成日時
       - `updated_at`: 更新日時
       - `deleted_at`: 削除日時

     - モデルファイル: `Site.php`
     - マイグレーションファイル: `02_create_sites_table.php`
     - ユニークキー: `site_code`, `url`
     - インデックス: `name`, `description`
     - 外部キー: `company_id`

## 依存関係
- Laravelフレームワーク v11.0以上
- PHP 8.3以上
- データベース（MySQL 8.0以上）
- 認証システム（Laravel Sanctum）
- バリデーションシステム（Laravel Validator）

## バリデーションルール
- **FavoriteItemテーブル**
  1. `user_id`: 必須, 存在するユーザーのID
  2. `item_id`: 必須, 存在する商品のID
  3. `site_id`: 必須, 存在するサイトのID

## 機能を実行するサービスクラス
- クラス名: `App\Services\FavoriteItem\FavoriteItemUpdateService`
- 名前空間: `App\Services\FavoriteItem`
- 主要メソッド: 
  - `execute(int $userId, int $itemId, int $siteId): FavoriteItem`

## 機能のビジネスロジック
1. リクエストデータのバリデーション
   - 必須項目の確認: `user_id`, `item_id`, `site_id`が含まれていることを確認
   - 存在確認:
     - `user_id`がUsersテーブルに存在することを確認
     - `item_id`がItemsテーブルに存在することを確認
     - `site_id`がSitesテーブルに存在することを確認
   - 重複チェック: `user_id`, `item_id`, `site_id`の組み合わせが既に存在しないことを確認
   - CSRFトークンの検証

2. お気に入り商品情報の更新
   - FavoriteItemsテーブルの更新: 
     - 指定された`user_id`, `item_id`, `site_id`のレコードを更新

3. レスポンス生成
   - 更新成功時: リダイレクトレスポンス（フラッシュメッセージ付き）
   - エラー時: バリデーションエラーメッセージと共に元のページにリダイレクト

## エラーハンドリング
- バリデーションエラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: 各項目のバリデーションエラー内容を返却
- 存在しないエンティティエラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "指定されたユーザー、商品、またはサイトが見つかりません"
- 重複エラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "この商品は既にお気に入りに登録されています"
- データベースエラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "お気に入り商品の更新に失敗しました。システム管理者に連絡してください"
  - ログ出力: エラー詳細（SQL, パラメータ, エラーメッセージ）

## テストケース
### お気に入り商品更新機能のテストケース
1. 正常系
   - 必須項目のみで更新
     - 期待結果: リダイレクト（302）、フラッシュメッセージ "お気に入り商品を更新しました"

2. 異常系
   - バリデーションエラー
     - user_idが未指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "user_idは必須です"
   - 重複エラー
     - 既存のuser_id, item_id, site_idの組み合わせを指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "この商品は既にお気に入りに登録されています"
   - 存在しないエンティティエラー
     - 存在しないuser_id, item_id, site_idを指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "指定されたユーザー、商品、またはサイトが見つかりません"
   - CSRFトークンエラー
     - 無効なCSRFトークンでリクエスト
       - 期待結果: 419エラー

## その他
- お気に入り商品の更新はWebUIからフォーム送信で実行されます。
- CSRFトークンによる保護が必要です。
- セッションフラッシュメッセージを使用して、処理結果をユーザーに通知します。

