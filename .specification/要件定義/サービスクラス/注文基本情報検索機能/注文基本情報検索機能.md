# 注文基本情報検索機能仕様

## 概要
注文基本情報（Orders）の検索を行う機能です。この機能により、管理者やオペレーターは注文情報を検索・閲覧することができます。

## 機能の対象
- オペレーター
- 管理者

## 使用テーブル構成
1. **注文基本情報**
   - **Orderモデル**（Ordersテーブル）
     - フィールド:
       - `order_code`: ULID形式で一意
       - `site_id`: サイトのID
       - `user_id`: 顧客のID
       - `total_price`: 合計金額
       - `tax`: 税金
       - `postage`: 送料
       - `ordered_at`: 注文日時
       - `processed_at`: 処理日時
       - `exported_at`: 出荷日時
       - `created_at`: 作成日時
       - `updated_at`: 更新日時
       - `deleted_at`: 削除日時

     - モデルファイル: `Order.php`
     - マイグレーションファイル: `16_create_orders_table.php`
     - ユニークキー: `order_code`
     - インデックス: `site_id`, `user_id`, `ordered_at`, `processed_at`

## 依存関係
- Laravelフレームワーク v11.0以上
- PHP 8.3以上
- データベース（MySQL 8.0以上）
- バリデーションシステム（Laravel Validator）
- ページネーション（Laravel Pagination）
- キャッシュシステム（Laravel Cache）

## 機能を実行するサービスクラス
- クラス名: `App\Services\Order\OrderSearchService`
- 名前空間: `App\Services\Order`
- 主要メソッド: 
  - `execute(array $searchParams): LengthAwarePaginator`

## バリデーションルール
- **検索条件**
  1. `order_code`: 任意, ULID形式
  2. `site_id`: 任意, 整数値, 存在するサイトのID
  3. `user_id`: 任意, 整数値, 存在するユーザーのID
  4. `total_price_min`: 任意, 数値, 0以上
  5. `total_price_max`: 任意, 数値, total_price_min以上
  6. `ordered_at_from`: 任意, 日付形式（Y-m-d）
  7. `ordered_at_to`: 任意, 日付形式（Y-m-d）, ordered_at_from以降
  8. `processed_at_from`: 任意, 日付形式（Y-m-d）
  9. `processed_at_to`: 任意, 日付形式（Y-m-d）, processed_at_from以降
  10. `page`: 任意, 整数値, 1以上
  11. `per_page`: 任意, 整数値, 10, 20, 50のいずれか
  12. `sort_by`: 任意, 文字列, [order_code, total_price, ordered_at, processed_at]のいずれか
  13. `sort_order`: 任意, 文字列, [asc, desc]のいずれか

## 機能のビジネスロジック
1. 検索条件のバリデーション
   - 検索条件の確認: 各フィルタ条件が正しい形式であることを確認
   - CSRFトークンの検証

2. 注文情報の検索
   - Ordersテーブルから条件に合致する注文を検索
   - 関連テーブルとの結合（ユーザー、サイト情報）
   - ページネーション処理の実装
   - ソート処理の実装

3. レスポンス生成
   - 検索成功時: 検索結果一覧ページを表示（ページネーション情報付き）
   - エラー時: エラーメッセージと共に検索フォームページにリダイレクト

## エラーハンドリング
- バリデーションエラー
  - 処理: セッションにエラーメッセージを格納し、検索フォームページにリダイレクト
  - エラーメッセージ: 各項目のバリデーションエラー内容を返却
- データベースエラー
  - 処理: セッションにエラーメッセージを格納し、検索フォームページにリダイレクト
  - エラーメッセージ: "注文情報の検索に失敗しました。システム管理者に連絡してください"
  - ログ出力: エラー詳細（SQL, パラメータ, エラーメッセージ）

## テストケース
1. 正常系
   - 全ての注文を検索
     - 期待結果: 検索結果一覧ページが表示される
   - 特定の注文コードで検索
     - 期待結果: 該当する注文情報が表示される
   - 金額範囲で検索
     - 期待結果: 指定した金額範囲内の注文が表示される
   - 日付範囲で検索
     - 期待結果: 指定した日付範囲内の注文が表示される
   - ページネーション
     - 期待結果: 指定したページの結果が表示される
   - ソート
     - 期待結果: 指定した順序で結果が表示される

2. 異常系
   - バリデーションエラー
     - 無効な金額範囲を指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "金額範囲の指定が不正です"
     - 無効な日付範囲を指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "日付範囲の指定が不正です"
   - 不正なページ番号
     - 期待結果: リダイレクト（302）、エラーメッセージ: "不正なページ番号が指定されました"
   - CSRFトークンエラー
     - 期待結果: 419エラー

## パフォーマンス対策
1. データベース
   - インデックスの最適化
   - クエリのキャッシュ
   - 必要最小限のカラム取得

2. キャッシュ
   - 検索結果のキャッシュ（短期）
   - マスターデータのキャッシュ
   - バリデーションルールのキャッシュ

## その他
- 注文の検索はWebUIから実行されます。
- CSRFトークンによる保護が必要です。
- セッションフラッシュメッセージを使用して、処理結果をユーザーに通知します。
- ページネーション機能により、大量の検索結果を適切に表示します。
- 検索条件は検索フォームのGETパラメータとして送信されます。
- 検索結果は並び替え可能です（注文コード、合計金額、注文日時など）。
- 検索条件は検索履歴として保存され、再利用可能です。 
