# 顧客削除機能仕様

## 概要
顧客（Customer）の論理削除を行う機能です。この機能により、管理者やオペレーターは不要になった顧客情報を安全に削除することができます。

## 機能の対象
- オペレーター
- 管理者

## 使用テーブル構成
1. **ユーザー情報**
   - **Userモデル**（Usersテーブル）
     - フィールド:
       - `user_code`
       - `site_id`
       - `name`
       - `postal_code`
       - `address`
       - `phone`
       - `phone2`
       - `fax`
       - `created_at`
       - `updated_at`
       - `deleted_at`

     - モデルファイル: `User.php`
     - マイグレーションファイル: `03_modify_users_table.php`
     - ユニークキー: `user_code`
     - インデックス: `name`
     - 外部キー: `site_id`

2. **認証情報**
   - **Authenticateモデル**（Authenticatesテーブル）
     - フィールド:
       - `auth_code`
       - `site_id`
       - `entity_type`
       - `entity_id`
       - `login_code`
       - `password`
       - `expires_at`
       - `created_at`
       - `updated_at`
       - `deleted_at`

     - モデルファイル: `Authenticate.php`
     - マイグレーションファイル: `12_create_authenticates_table.php`
     - ユニークキー: `auth_code`
     - インデックス: `entity_type`, `entity_id`
     - 外部キー: `site_id`

## 依存関係
- Laravelフレームワーク v11.0以上
- PHP 8.3以上
- データベース（MySQL 8.0以上）
- バリデーションシステム（Laravel Validator）

## 機能を実行するサービスクラス
- クラス名: `App\Services\Customer\CustomerDeleteService`
- 名前空間: `App\Services\Customer`
- 主要メソッド: 
  - `execute(string $userCode, int $siteId): bool`

## 機能のビジネスロジック
1. 削除前チェック
   - 対象顧客の存在確認: 指定された`user_code`がUsersテーブルに存在することを確認
   - サイトの存在確認: `site_id`がSitesテーブルに存在することを確認
   - 削除権限の確認: 操作を行うユーザーが削除権限を持っていることを確認
   - CSRFトークンの検証

2. 顧客情報の論理削除
   - トランザクション開始
   - Usersテーブルの論理削除: 
     - `deleted_at`フィールドを現在時刻で更新
   - 関連テーブルの論理削除:
     - Authenticatesテーブル: 対応する認証情報の`deleted_at`を更新
     - AuthenticateOauthsテーブル: 対応するOAuth情報の`deleted_at`を更新
     - その他関連テーブル: 必要に応じて`deleted_at`を更新
   - トランザクション終了

3. レスポンス生成
   - 削除成功時: リダイレクトレスポンス（フラッシュメッセージ付き）
   - エラー時: エラーメッセージと共に元のページにリダイレクト

## エラーハンドリング
- 顧客不在エラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "指定された顧客が見つかりません"
- サイト不在エラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "指定されたサイトが見つかりません"
- 権限エラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "この操作を実行する権限がありません"
- データベースエラー
  - 処理: セッションにエラーメッセージを格納し、元のページにリダイレクト
  - エラーメッセージ: "顧客情報の削除に失敗しました。システム管理者に連絡してください"
  - ログ出力: エラー詳細（SQL, パラメータ, エラーメッセージ）

## テストケース
1. 正常系
   - 存在する顧客を削除
     - 期待結果: リダイレクト（302）、フラッシュメッセージ "顧客情報を削除しました"
   - 関連情報を持つ顧客を削除
     - 期待結果: リダイレクト（302）、フラッシュメッセージ "顧客情報を削除しました"

2. 異常系
   - 顧客不在エラー
     - 存在しない顧客IDを指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "指定された顧客が見つかりません"
   - サイト不在エラー
     - 存在しないsite_idを指定
       - 期待結果: リダイレクト（302）、エラーメッセージ: "指定されたサイトが見つかりません"
   - 権限エラー
     - 権限のないユーザーが削除を試みる
       - 期待結果: リダイレクト（302）、エラーメッセージ: "この操作を実行する権限がありません"
   - CSRFトークンエラー
     - 無効なCSRFトークンでリクエスト
       - 期待結果: 419エラー

## その他
- 顧客の削除はWebUIからフォーム送信で実行されます。
- CSRFトークンによる保護が必要です。
- セッションフラッシュメッセージを使用して、処理結果をユーザーに通知します。
- トランザクション制御により、データの整合性を保証します。
- 物理削除は行わず、論理削除のみを実装します。
